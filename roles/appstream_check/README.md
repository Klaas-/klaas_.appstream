# appstream_check role

Checks installed RPMs and modular streams against Red Hat AppStream lifecycle data and reports items that are past end-of-life.

## What this role does

1. Collects package facts.
2. Detects target OS major version (`el8`, `el9`, ...).
3. Ensures date facts are available.
4. Loads AppStream reference data from `vars/redhat_appstreams.yml`.
5. Runs module `appstream_check` from this collection.
6. Exposes simplified facts for downstream roles/playbooks.

## Requirements

- RHEL-like system with `rpm` available.
- Python available on target host for Ansible module execution.

## Role variables

Defaults in `defaults/main.yml`:

- `appstream_check_fail_on_match` (bool, default: `false`)
  - If `true`, role fails when retired packages/modules are found.
- `appstream_check_date` (optional, string `YYYY-MM-DD`)
  - If set, overrides the comparison date used by the module.
  - If not set, the module uses the current date of the target machine.

Loaded data:

- `appstream_check_grouped`
  - Provided by `vars/redhat_appstreams.yml`.
  - Grouped by OS major key (for example `el8`, `el9`).

How `vars/redhat_appstreams.yml` is created:

- Generated by the helper script `scripts/redhat_get_appstreams.py`.
- Script default output is exactly this file path and YAML variable name `appstream_check_grouped`.
- In this collection, the file is also updated automatically by GitHub Actions workflow `.github/workflows/update-appstreams.yml` (scheduled weekly and runnable manually).
- Requires `OFFLINE_ACCESS_TOKEN` in environment (Red Hat SSO offline token).
- Install script dependencies from `scripts/requirements.txt` (`aiohttp`, `PyYAML`).
- Example run from repo root:

```bash
pip install -r scripts/requirements.txt
OFFLINE_ACCESS_TOKEN="<token>" python scripts/redhat_get_appstreams.py --log-level INFO
```

## Custom module interface

Module: `plugins/modules/appstream_check.py`

Inputs:

- `grouped_data` (required, dict)
- `fail_on_match` (optional, bool, default `false`)
- `target_major` (optional, string like `el8`; autodetected if omitted)
- `date` (optional, `YYYY-MM-DD`; today if omitted)

Outputs:

- `appstream_check_result`
  - `target_major`
  - `matched_packages`
  - `matched_dnf_modules`
  - `matched_dnf_modules_packages`
  - `any_match`
- `packages_to_remove`
- `date`

## Facts exported by this role

From `tasks/main.yml`:

- `appstream_check_result`
- `appstream_check_packages_to_remove`

## Example usage

```yaml
- hosts: all
  become: true
  roles:
    - role: appstream_check
      vars:
        appstream_check_fail_on_match: true
        appstream_check_date: "2026-08-15"
```

Second example (do not fail and use current host date):

```yaml
- hosts: all
  become: true
  roles:
    - role: appstream_check
```

Third example (today + 180 days):

```yaml
- hosts: all
  become: true
  vars:
    appstream_check_date: "{{ ((ansible_date_time.epoch | int) + (180 * 24 * 60 * 60)) | strftime('%Y-%m-%d') }}"
  roles:
    - role: appstream_check
```

## Notes

- Date comparisons use `YYYY-MM-DD` strings from lifecycle data.
- This role reports lifecycle status; removal actions belong in cleanup automation.
