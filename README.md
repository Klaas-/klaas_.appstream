# klaas_.appstream collection

Ansible Collection for checking AppStream lifecycle status on EL systems and optionally removing retired packages.

Parts of this project are inspired by https://github.com/knumskull/redhat-rhel-appstream-lifecycle-query

AI Disclaimer: This package was created with assistance of GitHub Copilot.

## Collection info

- Collection name: `klaas_.appstream`
- Metadata: `galaxy.yml`
- Module: `plugins/modules/appstream_check.py`
- Scripts docs: `scripts/README.md`

## Included roles

- `appstream_check` (`roles/appstream_check`)
	- Evaluates installed packages/modules against lifecycle data.
	- Exposes `appstream_check_result` and `appstream_check_packages_to_remove` facts.
	- See role docs: `roles/appstream_check/README.md`

- `appstream_cleanup` (`roles/appstream_cleanup`)
	- Removes packages from `appstream_check_packages_to_remove`.
	- Auto-runs `appstream_check` if cleanup list is missing.
	- See role docs: `roles/appstream_cleanup/README.md`

## AppStreams data source

Lifecycle reference data is stored in:

- `roles/appstream_check/vars/redhat_appstreams.yml`

This file is generated by:

- Script: `scripts/redhat_get_appstreams.py`
- Default YAML variable key: `appstream_check_grouped`

Prerequisites for manual update:

- `OFFLINE_ACCESS_TOKEN` environment variable (Red Hat SSO offline token)
- Dependencies from `scripts/requirements.txt`

Manual update example:

```bash
pip install -r scripts/requirements.txt
OFFLINE_ACCESS_TOKEN="<token>" python scripts/redhat_get_appstreams.py --log-level INFO
```

## Automation

The AppStreams vars file is updated automatically by GitHub Actions:

- Workflow: `.github/workflows/update-appstreams.yml`
- Schedule: weekly (Monday 03:00 UTC)
- Trigger: scheduled and manual (`workflow_dispatch`)

## Standalone shell usage

You can run the same AppStream check logic outside Ansible:

```bash
pip3 install -r scripts/requirements.txt
python3 scripts/appstream_check_standalone.py
```

Useful options:

```bash
python3 scripts/appstream_check_standalone.py --target-major el9 --date 2026-02-17 --output-format json
python3 scripts/appstream_check_standalone.py --fail-on-match
```

The script reads grouped data from:

- `roles/appstream_check/vars/redhat_appstreams.yml`

Override via `--grouped-data-file` if needed.

## Testing

This collection uses [antsibull-nox](https://docs.ansible.com/projects/antsibull-nox/) with [nox](https://nox.thea.codes/) for testing.

```bash
pip install nox antsibull-nox
nox
```

Sessions include sanity tests, unit tests, linting, yamllint, typing, and code quality checks.
